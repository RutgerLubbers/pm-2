#!/usr/bin/env bash

DOWNLOAD_DIR="/opt/vagrant-box/download"
if [ ! -d ${DOWNLOAD_DIR} ]; then
  mkdir -p ${DOWNLOAD_DIR}
fi

RESET="\e[0m"
NORMAL="\e[21m\e[39m"
BOLD="\e[1m"
RESET_BOLD="\e[21m"
DIM="\e[2m"
RESET_DIM="\e[22m"
BLUE="\e[94m"
RED="\e[91m"
YELLOW="\e[93m"

function detect_apt_cacher() {
  DEFAULT_GW=`netstat -rn | grep '^0.0.0.0' | awk '{print $2}'`
  if [[ ${DEFAULT_GW} =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]
  then
  	  if nc -z "${DEFAULT_GW}" 3142 -w 5; then
		  blue "  Using apt caching proxy"
		  enable-apt-proxy
	  else
	    red "  Not using apt caching proxy."
	    disable-apt-proxy
	  fi
  fi
}

function blue {
  echo -e "${BLUE}${@}${RESET}"
}
function red {
  echo -e "${RED}${@}${RESET}"
}
function yellow {
  echo -e "${YELLOW}${@}${RESET}"
}
function println {
  echo -e "  ${NORMAL}${@}${RESET}"
}

function download {
  DOWNLOAD_FILE="${1}"
  DOWNLOAD_URL="${2}"

  if [ ! -e ${DOWNLOAD_DIR}/${DOWNLOAD_FILE} ]
  then
    println "Downloading '${BLUE}${DOWNLOAD_FILE}${RESET}'"
    println "       from '${BLUE}${DOWNLOAD_URL}${RESET}'."
    if ! curl -fs ${DOWNLOAD_URL} -o ${DOWNLOAD_DIR}/${DOWNLOAD_FILE}
    then
      red "Unable to download '${DOWNLOAD_FILE}' from '${DOWNLOAD_URL}'"
      exit 1
    fi
  fi
}

function install_bin {
  # Do not fail, nor complain, on files not present in the '${SRC_DIR}/bin' directory.
  cp ${SRC_DIR}/bin/* /home/vagrant/bin 2>/dev/null || true

  update_bin
}

function update_bin {
  dos2unix -q /home/vagrant/bin/*
  chmod +x /home/vagrant/bin/*
  chown -R vagrant: /home/vagrant/bin
}

if [ $EUID != 0 ]; then
  red "Please run this as root:"
  echo -n "   sudo "
  echo -n `basename ${0}`
  echo " $*"
  exit 1
fi

if [ "$#" -lt 1 ]; then
  red "Usage: `basename $0` what [dir]"
  exit -1
fi

INSTALLER="${1}"
INSTALLER_DIR="/installers/${INSTALLER}"
TMP_DIR="${2}"

if [ ! -d "${INSTALLER_DIR}" ]; then
  echo "Directory '${INSTALLER_DIR}' does not exist."
  exit -1
fi

set -e
export DEBIAN_FRONTEND=noninteractive

# Create a temp dir to work in, so dos2unix won't cause changes in the original files
if [ -z "${TMP_DIR}" ]; then
  TMP_DIR=$(mktemp -dt "$(basename $0).XXXXXXXXXX")
#  trap 'rm -rf "${TMP_DIR}"' EXIT
fi
chmod o+rx ${TMP_DIR}

SRC_DIR="${TMP_DIR}/${INSTALLER}"
mkdir -p "${SRC_DIR}"
cp -a "${INSTALLER_DIR}"/* "${SRC_DIR}"

if [ -f /vagrant/vagrant-box.conf ]
then
    cp /vagrant/vagrant-box.conf "${SRC_DIR}"
else
    cp /vagrant/vagrant-box.conf.defaults "${SRC_DIR}/vagrant-box.conf"
fi


blue  "Installing '${BOLD}${INSTALLER}${RESET_BOLD}'."
detect_apt_cacher
yellow "  Using dir '${SRC_DIR}'."
yellow "  Converting installer files to unix format."

find "${SRC_DIR}" -type f -print0 | xargs -0 dos2unix -q
find "${SRC_DIR}" -iname *.sh -print0 | xargs -0 chmod +x

export SRC_DIR="${SRC_DIR}"
cd "${SRC_DIR}"
source vagrant-box.conf
if [ ! -e "${SRC_DIR}/provision.sh" ]
then
    echo "No provision script in '${SRC_DIR}'."
    exit -1
fi


source ${SRC_DIR}/provision.sh

